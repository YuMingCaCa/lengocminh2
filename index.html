<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ƒêi·ªÉm Thi - qlylaodong-dev</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Form Styles */
        .form-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        
        /* N√∫t ch√≠nh (Xanh l√°) */
        button#mainBtn { background-color: #28a745; }
        button#mainBtn:hover { background-color: #218838; }
        
        /* N√∫t h·ªßy (X√°m) - M·∫∑c ƒë·ªãnh ·∫©n */
        button#cancelBtn { background-color: #6c757d; display: none; } 
        button#cancelBtn:hover { background-color: #5a6268; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f1f1f1; }
        
        /* Action Buttons */
        .action-group { display: flex; gap: 5px; }
        .edit-btn { background-color: #ffc107; color: #333; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .edit-btn:hover { background-color: #e0a800; }
        .delete-btn { background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .delete-btn:hover { background-color: #c82333; }
        
        .loading { text-align: center; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <h1>Qu·∫£n L√Ω ƒêi·ªÉm Thi üéì</h1>

    <div class="card">
        <h3 id="formTitle">Th√™m m√¥n h·ªçc m·ªõi</h3>
        <div class="form-group">
            <input type="text" id="subjectInput" placeholder="T√™n m√¥n h·ªçc (VD: To√°n Cao C·∫•p)">
            <input type="number" id="scoreInput" placeholder="ƒêi·ªÉm s·ªë" step="0.1" max="10">
            <button id="mainBtn">L∆∞u ƒëi·ªÉm</button>
            <button id="cancelBtn">H·ªßy s·ª≠a</button>
        </div>
    </div>

    <div class="card">
        <h3>B·∫£ng ƒëi·ªÉm c·ªßa t√¥i</h3>
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>M√¥n h·ªçc</th>
                    <th>ƒêi·ªÉm</th>
                    <th style="width: 150px;">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
        <p id="loadingMsg" class="loading">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Firebase...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Import th√™m updateDoc ƒë·ªÉ s·ª≠a d·ªØ li·ªáu
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, updateDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCET0_R6120tj389v5C62NhSLrBIk2CbIw",
            authDomain: "qlylaodong-dev.firebaseapp.com",
            projectId: "qlylaodong-dev",
            storageBucket: "qlylaodong-dev.firebasestorage.app",
            messagingSenderId: "789374516793",
            appId: "1:789374516793:web:29fb38ad0913f8b62e17e8",
            measurementId: "G-M2PJEBLMJF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "exam_scores";

        // BI·∫æN QU·∫¢N L√ù TR·∫†NG TH√ÅI S·ª¨A
        let isEditing = false;
        let currentEditId = null;

        // DOM Elements
        const mainBtn = document.getElementById('mainBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const subjectInput = document.getElementById('subjectInput');
        const scoreInput = document.getElementById('scoreInput');
        const formTitle = document.getElementById('formTitle');
        const tableBody = document.getElementById('tableBody');
        const loadingMsg = document.getElementById('loadingMsg');

        // 1. X·ª¨ L√ù N√öT L∆ØU / C·∫¨P NH·∫¨T
        mainBtn.addEventListener('click', async () => {
            const subject = subjectInput.value;
            const score = scoreInput.value;

            if (!subject || !score) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n m√¥n v√† ƒëi·ªÉm!");
                return;
            }

            try {
                if (isEditing) {
                    // --- LOGIC S·ª¨A (UPDATE) ---
                    const docRef = doc(db, COLLECTION_NAME, currentEditId);
                    await updateDoc(docRef, {
                        subject: subject,
                        score: parseFloat(score),
                        // Kh√¥ng update createdAt ƒë·ªÉ gi·ªØ nguy√™n v·ªã tr√≠ s·∫Øp x·∫øp
                    });
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    resetFormState(); // Quay v·ªÅ tr·∫°ng th√°i th√™m m·ªõi
                } else {
                    // --- LOGIC TH√äM M·ªöI (CREATE) ---
                    await addDoc(collection(db, COLLECTION_NAME), {
                        subject: subject,
                        score: parseFloat(score),
                        createdAt: serverTimestamp()
                    });
                }
                
                // X√≥a tr·∫Øng √¥ input sau khi xong
                subjectInput.value = '';
                scoreInput.value = '';
                subjectInput.focus();

            } catch (e) {
                console.error("L·ªói: ", e);
                alert("C√≥ l·ªói x·∫£y ra: " + e.message);
            }
        });

        // 2. N√öT H·ª¶Y S·ª¨A
        cancelBtn.addEventListener('click', () => {
            subjectInput.value = '';
            scoreInput.value = '';
            resetFormState();
        });

        function resetFormState() {
            isEditing = false;
            currentEditId = null;
            mainBtn.innerText = "L∆∞u ƒëi·ªÉm";
            mainBtn.style.backgroundColor = "#28a745"; // V·ªÅ m√†u xanh l√°
            formTitle.innerText = "Th√™m m√¥n h·ªçc m·ªõi";
            cancelBtn.style.display = "none"; // ·∫®n n√∫t h·ªßy
        }

        // 3. HI·ªÇN TH·ªä D·ªÆ LI·ªÜU (READ)
        const q = query(collection(db, COLLECTION_NAME), orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
            loadingMsg.style.display = 'none';
            tableBody.innerHTML = '';

            if (snapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            }

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const row = `
                    <tr>
                        <td><strong>${data.subject}</strong></td>
                        <td>${data.score}</td>
                        <td class="action-group">
                            <button class="edit-btn" 
                                data-id="${docSnap.id}" 
                                data-subject="${data.subject}" 
                                data-score="${data.score}">S·ª≠a</button>
                            <button class="delete-btn" data-id="${docSnap.id}">X√≥a</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // G√°n s·ª± ki·ªán cho c√°c n√∫t S·ª≠a v√† X√≥a
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
        });

        // 4. CH·ª®C NƒÇNG X·ª¨ L√ù S·ª∞ KI·ªÜN N√öT S·ª¨A
        function handleEdit(e) {
            // L·∫•y d·ªØ li·ªáu t·ª´ n√∫t b·∫•m
            const id = e.target.getAttribute('data-id');
            const subject = e.target.getAttribute('data-subject');
            const score = e.target.getAttribute('data-score');

            // ƒê∆∞a d·ªØ li·ªáu l√™n form
            subjectInput.value = subject;
            scoreInput.value = score;

            // Chuy·ªÉn sang tr·∫°ng th√°i s·ª≠a
            isEditing = true;
            currentEditId = id;

            // ƒê·ªïi giao di·ªán
            formTitle.innerText = "ƒêang s·ª≠a: " + subject;
            mainBtn.innerText = "C·∫≠p nh·∫≠t";
            mainBtn.style.backgroundColor = "#ffc107"; // M√†u v√†ng c·∫£nh b√°o
            mainBtn.style.color = "#333";
            cancelBtn.style.display = "inline-block"; // Hi·ªán n√∫t h·ªßy
            
            // Cu·ªôn l√™n ƒë·∫ßu trang ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 5. CH·ª®C NƒÇNG X√ìA
        async function handleDelete(e) {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒëi·ªÉm m√¥n n√†y kh√¥ng?')) {
                const id = e.target.getAttribute('data-id');
                // N·∫øu ƒëang s·ª≠a ch√≠nh m√¥n mu·ªën x√≥a th√¨ reset form tr∆∞·ªõc
                if (id === currentEditId) resetFormState();
                
                try {
                    await deleteDoc(doc(db, COLLECTION_NAME, id));
                } catch (e) {
                    alert("X√≥a th·∫•t b·∫°i: " + e.message);
                }
            }
        }
    </script>
</body>
</html>
